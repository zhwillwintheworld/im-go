#!/bin/bash

# FlatBuffers Go ä»£ç ç”Ÿæˆè„šæœ¬
# éœ€è¦å…ˆå®‰è£… flatc: brew install flatbuffers

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCHEMA_FILE="${SCRIPT_DIR}/message.fbs"
OUTPUT_DIR="${SCRIPT_DIR}/../project/access-go/pkg/flatbuf"

# æ£€æŸ¥ flatc æ˜¯å¦å®‰è£…
if ! command -v flatc &> /dev/null; then
    echo "é”™è¯¯: flatc æœªå®‰è£…"
    echo "è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…:"
    echo "  brew install flatbuffers"
    exit 1
fi

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p "${OUTPUT_DIR}"

# æ¸…ç†æ—§çš„ç”Ÿæˆæ–‡ä»¶ï¼ˆåªåˆ é™¤ FlatBuffers è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼‰
echo "ğŸ§¹ æ¸…ç†æ—§çš„ FlatBuffers ç”Ÿæˆæ–‡ä»¶..."
if [ -d "${OUTPUT_DIR}" ]; then
    # åªåˆ é™¤åŒ…å« "automatically generated by the FlatBuffers compiler" çš„ Go æ–‡ä»¶
    find "${OUTPUT_DIR}" -name "*.go" -type f -exec grep -l "automatically generated by the FlatBuffers compiler" {} \; | while read file; do
        echo "  åˆ é™¤: $(basename "$file")"
        rm -f "$file"
    done
fi

# ç”Ÿæˆ Go ä»£ç 
echo ""
echo "ğŸ“¦ ç”Ÿæˆ FlatBuffers Go ä»£ç ..."
flatc --go -o "${OUTPUT_DIR}" "${SCHEMA_FILE}"

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ… Go ä»£ç ç”ŸæˆæˆåŠŸ!"
    echo "ğŸ“ è¾“å‡ºç›®å½•: ${OUTPUT_DIR}"
    echo ""
    echo "ğŸ“‹ å·²ç”Ÿæˆçš„æ–‡ä»¶:"
    find "${OUTPUT_DIR}" -name "*.go" -type f 2>/dev/null | while read file; do
        echo "  - $(basename "$file")"
    done | head -20
else
    echo ""
    echo "âŒ ä»£ç ç”Ÿæˆå¤±è´¥"
    exit 1
fi
