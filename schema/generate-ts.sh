#!/bin/bash

# FlatBuffers TypeScript ä»£ç ç”Ÿæˆè„šæœ¬
# éœ€è¦å…ˆå®‰è£… flatc: brew install flatbuffers

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCHEMA_FILE="${SCRIPT_DIR}/message.fbs"
# flatc ä¼šæ ¹æ® namespace im.protocol è‡ªåŠ¨åˆ›å»º im/protocol/ å­ç›®å½•
# è¾“å‡ºåˆ° src/ï¼Œæœ€ç»ˆè·¯å¾„æ˜¯ src/im/protocol/
TS_OUTPUT_DIR="${SCRIPT_DIR}/../project/desktop-web/src"

# æ£€æŸ¥ flatc æ˜¯å¦å®‰è£…
if ! command -v flatc &> /dev/null; then
    echo "é”™è¯¯: flatc æœªå®‰è£…"
    echo "è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…:"
    echo "  brew install flatbuffers"
    exit 1
fi

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p "${TS_OUTPUT_DIR}"

# æ¸…ç†æ—§çš„ç”Ÿæˆæ–‡ä»¶ï¼ˆåªåˆ é™¤ FlatBuffers è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼‰
echo "ğŸ§¹ æ¸…ç†æ—§çš„ FlatBuffers ç”Ÿæˆæ–‡ä»¶..."
CLEAN_DIR="${TS_OUTPUT_DIR}/im/protocol"
if [ -d "${CLEAN_DIR}" ]; then
    # åªåˆ é™¤åŒ…å« "automatically generated by the FlatBuffers compiler" çš„æ–‡ä»¶
    find "${CLEAN_DIR}" -name "*.ts" -type f -exec grep -l "automatically generated by the FlatBuffers compiler" {} \; | while read file; do
        echo "  åˆ é™¤: $(basename "$file")"
        rm -f "$file"
    done
fi

# ç”Ÿæˆ TypeScript ä»£ç 
echo ""
echo "ğŸ“¦ ç”Ÿæˆ FlatBuffers TypeScript ä»£ç ..."
flatc --ts -o "${TS_OUTPUT_DIR}" "${SCHEMA_FILE}"

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ… TypeScript ä»£ç ç”ŸæˆæˆåŠŸ!"
    echo "ğŸ“ è¾“å‡ºç›®å½•: ${TS_OUTPUT_DIR}"
    echo ""
    echo "ğŸ“‹ å·²ç”Ÿæˆçš„æ–‡ä»¶:"
    ls -1 "${TS_OUTPUT_DIR}"/*.ts 2>/dev/null | while read file; do
        echo "  - $(basename "$file")"
    done
    echo ""
    echo "âœ¨ å®Œæˆï¼æ–°å¢çš„åè®®å­—æ®µ:"
    echo "  - RoomAction.CHANGE_SEAT"
    echo "  - RoomAction.START_GAME"
    echo "  - RoomReq.target_seat_index"
else
    echo ""
    echo "âŒ ä»£ç ç”Ÿæˆå¤±è´¥"
    exit 1
fi
